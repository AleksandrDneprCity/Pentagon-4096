# Pentagon-4096
This is new ZX-Spectrum clone
Версия 10.7.

Актуальные ревизии плат: Материнская плата (MainBoard) - 10.7.1. Верхняя плата (TopBoard) - 5.3.0.

Новый "Pentagon-4096", это новый клон ZX-Spectrum, собранный на классической мелкой логике, но с применением ARV микроконтроллеров.
Новый ZX-Spectrum совместимый компьютер вобрал в себя всё лучшее, что было в оригинальном Pentagon-128, но в него добавлены 
ряд исправлений и дополнений, реализованы ряд функциональных возможностей:

1) Полная совместимость, в том числе и по положению сигнала прерывания INT, с оригинальным "Pentagon-128". Но с возможностью переключения 
положения сигнала INT в положение "Фирменный ZX-Spectrum" (на 16 телевизионных строк вниз + на 13.71 мкс вправо), с целью исключения 
мерцания спрайтов в ряде фирменных играх.

2) Формирование видеосигнала с полностью стандартными синхро-импульсами и импульсами гашения, которые гарантируют нормальную работу с любым 
телевизором, а так же корректную работу PAL/NTSC и при необходимости, SECAM кодера.

3) Наличие PAL/NTSC кодера на микросхеме CXA1645 или CXA2075. Двумя перемычками можно выбирать стандарты: PAL 4.43 MHz, NSTC 3.58 MHz, NTSC 4.43 MHz.

4) Объём оперативной памяти 4 Мб с помощью 1 модуля SIMM 30 pin. Имеется возможность установки 1 модуля SIMM на 1 Мб, на плате имеется 
соответствующий джампер для переключения объёма установленного модуля памяти.

Вначале я хотел сделать ещё вариант установки двух модулей SIMM 30 pin по 1 Мб, но был вынужден отказаться от идеи, т.к. она не подружилась 
с турбированием ОЗУ на 7 МГц. Переключение модулей я делал стандартным способом - коммутацией сигнала CAS, но минимальной задержки 
этого сигнала оказалось достаточно, чтобы компьютер не заработал вообще. Хотя ещё оставалось конечно пару вариантов - коммутацию CAS 
я тогда сделал на К1531КП11, а нужно было попробовать на 1531ЛА3, но уже не буду возвращаться к этому варианту.

Расширении объёма памяти >128 КБ будет многостандартным, набор вариантов расширения памяти зависит от объёма установленного модуля SIMM 30 pin - 1МБ или 4МБ.

4.0: Доступные варианты расширения памяти для модуля SIMM 30 pin 1МБ:

4.0.0) Расширенную верхнюю память вообще можно отключить, оставив стандартные 128 КБ.

4.0.1) По стандарту "Пентагон-1024": За счёт дополнительных двух D6 и D7 битов порта 0x7FFD, а так же за счёт бита D5 (вместо блокировки),
получаем доступный объём ОЗУ 1024 КБ. Для совместимости с некоторыми программами, осбенно с фирменными, бит блокировки D5 этого порта
можно будет переназначать на своё первоначальное назначение - на блокировку всей верхней памяти (48 КБ). В этом случае доступный объём
ОЗУ будет составлять 512 КБ.

0x7FFD бит 7 - 256 КБ

0x7FFD бит 6 - 512 КБ

0x7FFD бит 5 - 1024 КБ (этот бит можно перенастроить на блокировку портов памяти, в этом случае доступный объём ОЗУ составит 512 КБ)

4.0.2) По стандарту "Профи-1024": За счёт порта 0xDFFD, битов D0, D1 и D2, ОЗУ будет доступно в объёме 1024 КБ:

0xDFFD бит 0 - 256 КБ

0xDFFD бит 1 - 512 КБ

0xDFFD бит 2 - 1024 КБ

4.0.3) За счёт чистого порта #1FFD, битов D4 и D7, ОЗУ будет доступно в объёме 512 КБ:

0x1FFD бит 4 - 256 КБ

0x1FFD бит 7 - 512 КБ

4.0.4) По стандарту "Kay-1024": За счёт порта 0x1FFD, битов D4 и D7, и порта #7FFD бита D7, ОЗУ будет доступно в объёме 1024 КБ:

0x1FFD бит 4 - 256 КБ

0x1FFD бит 7 - 512 КБ

0x7FFD бит 7 - 1024 КБ

4.1: Доступные варианты расширения памяти для модуля SIMM 30 pin 4МБ:

4.1.0) Расширенную верхнюю память вообще можно отключить, оставив стандартные 128 КБ.

4.1.1) По стандарту "Пентагон-1024": За счёт дополнительных двух D6 и D7 битов порта 0x7FFD, а так же за счёт бита D5 (вместо блокировки),
получаем доступный объём ОЗУ 1024 КБ. Для совместимости с некоторыми программами, осбенно с фирменными, бит блокировки D5 этого порта
можно будет переназначать на своё первоначальное назначение - на блокировку всей верхней памяти (48 КБ). В этом случае доступный объём
ОЗУ будет составлять 512 КБ.

0x7FFD бит 7 - 256 КБ

0x7FFD бит 6 - 512 КБ

0x7FFD бит 5 - 1024 КБ (этот бит можно перенастроить на блокировку портов памяти, в этом случае доступный объём ОЗУ составит 512 КБ)

4.1.2) По стандарту "Профи-1024": За счёт порта 0xDFFD, битов D0, D1 и D2, ОЗУ будет доступно в объёме 1024 КБ:

0xDFFD бит 0 - 256 КБ

0xDFFD бит 1 - 512 КБ

0xDFFD бит 2 - 1024 КБ

4.1.3) За счёт чистого порта #1FFD, битов D4 и D7, ОЗУ будет доступно в объёме 512 КБ:

0x1FFD бит 4 - 256 КБ

0x1FFD бит 7 - 512 КБ

4.1.4) По смешанному стандарту "Kay-1024" + "Pentagon-1024: За счёт порта 0x1FFD, битов D4 и D7, и порта #7FFD битов D6, D7 и D5, ОЗУ будет доступно в объёме 4096 КБ:

0x1FFD бит 4 - 256 КБ

0x1FFD бит 7 - 512 КБ

0x7FFD бит 6 - 1024 КБ

0x7FFD бит 7 - 2048 КБ

0x7FFD бит 5 - 4096 КБ (этот бит можно перенастроить на блокировку портов памяти, в этом случае доступный объём ОЗУ составит 2048 КБ)

4.1.5) По смешанному стандарту "Profi-1024" + "Pentagon-512: За счёт порта 0xDFFD, битов D0, D1 и D2, и порта #7FFD битов D6, D7, ОЗУ будет доступно в объёме 4096 КБ:

0xDFFD бит 0 - 256 КБ

0xDFFD бит 1 - 512 КБ

0xDFFD бит 2 - 1024 КБ

0x7FFD бит 6 - 2048 КБ

0x7FFD бит 7 - 4096 КБ

4.1.6) По смешанному стандарту "Profi-1024" + порт #1FFD: За счёт порта 0xDFFD, битов D0, D1 и D2, и порта #1FFD битов D4, D7, ОЗУ будет доступно в объёме 4096 КБ:

0xDFFD бит 0 - 256 КБ

0xDFFD бит 1 - 512 КБ

0xDFFD бит 2 - 1024 КБ

0x1FFD бит 4 - 2048 КБ

0x1FFD бит 7 - 4096 КБ


5) Наличие режима "Plus-3". Используются дополнительные 4 страницы ПЗУ, конфигурация ОЗУ становится такой же, как в фирменном 
"ZX-Spectrum+3" с поддержкой режимов "+3 SOS" и "+3 DOS" режимов.

6) В схеме имеется узел, который отлавливает команды короткой адресации к портам IN A,(xx), OUT (xx),A, благодаря которому, как только 
процессор попытается из ОЗУ извлечь код такой команды, моментально будет заблокирована вся верхняя память > 128 КБ, а порт 0x7FFD,
с помощью которого доступно ОЗУ объёмом 128 КБ, будет переведён на мягкую дешифрацию (с помощью битов A1 и A15). Как только процессор попытается из ОЗУ извлечь 
код любой другой команды, верхняя память разблокируется и порт #7FFD снова переводится на жёсткую дешифрацию.

7) Режим "Мультизадачность":
Мультизадачность можно будет включить через BIOS. В случае установленного модуля памяти SIMM 30 pin 4МБ, можно будет загружать в память до 31 задач одновременно.
Если будет установлен модуль памяти SIMM 30 pin 1МБ, то можно будет загружать в память до 7 задач одновременно.
Каждой задаче будет доступно 128 КБ памяти. Последний 32-й блок (или 8-й блок в случае установленного модуля SIMM 30 pin 1МБ) объёмом 128 КБ будет использоваться для хранения данных, необходимых для переключения на задачу.
Переключение между задачами планирую сделать по кнопке "Magic", где будет меню со списком загруженных задач.
 
8) Оперативная память турбирована на 7 МГц. Это позволило:
а) турбировать процессор Z80 на 7 МГц без WAIT-а, получив 200% производительности;
б) турбировать процессор Z80 на 14 МГц с WAIT-ом, получив 290% производительности;
в) реализовать дополнительные видеорежимы, требующие в 2 раза больше циклов доступа к ОЗУ видеоконтроллером, не останавливая процессор:
16 colors и 512х192 пикселей в цвете;

Из недостатков:

Компьютер будет работать не со всеми типами процессоров Z80. Отлично работает Z84C0020PEC, и их не сложно достать, поэтому в данном
проекте нужно использовать только этот процессор.

Возможно, придётся подбирать модули памяти SIMM. Обычно проблем не возникает с 3-чиповыми. В частности, отлично работают Motorolla, 
Samsung и др. Из всех не захотели работать только Panasonic. А вот 9-чиповые глючат, одни больше, другие меньше. из 7 или 8 разных 
модулей мне удалось подобрать только 2, которые более-менее нормально заработали, но всё равно хуже чем 3-чиповые.

Сложность в поиске быстрых микросхем логики серии КР1531. К счастью, не весь компьютер нужно собирать на этой серии, а только критичные 
к задержкам сигналов узлы. А то что достать не удалось, можно заменить на импортые аналоги серии 74Fxxx. 

Из дополнительных недостатков Турбо-14 МГц:

В этом режиме почему-то не хочет работать ОС iS-DOS, который зависает почти сразу после запуска, иногда портится при этом диск C: на HDD.
В то же время, все остальные проверенные мной программы, прекрасно раотают в режиме Турбо-14 МГц.

8) Шина Nemo-Bus v1.0 содержит 4 слота.

9) Возможность установки карт расширения "Plus-3". Для этого есть специальная плата-адаптер "NemobusToDivIDE", в которую можно будет устанавливать карты расширения 3+.
Эта плата устанавливается в слот NemoBus, а на неё саму устанавливается карта +3.

Дополнительная задача платы-адаптера является разрешение конфликтов устройства DivIDE с GeneralSound, у которых совпадают 2 порта 0xB3 и 0xBB.
Для разрешения конфликтов на плате реализован порт 0x33, который управляет блокировкой IORQ на карту +3 и генерацией IORQGE при обращении к портам 0xB3 и 0xBB.
Карта адаптера с установленным в неё DivIDE, должна быть установлена в слот NemoBus с большим приоритетом относительно General Sound. 
Перемычка на карте-адаптере должна быть снята.

В исходном состоянии IORQ на карту +3 не проходит, и IORQGE не генерируется, поэтому при обращении к портам 0xB3 и 0xBB отзываться будет General Sound.
Для того чтобы обратиться к DivIDE, необходимо в порт 0x33 выдать значение 0x10 (бит D4). IORQ для DivIDE разблокируется и при обращении к портам 0xB3 и 0xBB будет генерироваться IORQGE,
таким образом General Sound не будет мешать работе DivIDE.
Для того чтобы вернуть доступ к General Sound, достаточно в порт 0x33 записать значение 0.

Если в карту NemoBusToDivIDE будет установлена любая другая карта +3, которая не конфликтует с General Sound, то можно отключить блокировку IORQ, установив на карте-адаптера перемычку.
В этом случае управлять портом 0x33 не нужно.

11) Плюс 1 слот ISA специально для модема, включенного по схеме Кондратьева, полный вариант с прерыванием от модема IRQ4 по NMI. Использовать 
можно, к примеру, в iS-DOSе, можно будет с ПЦ и обратно перекачивать файлы размером больше дискеты, не придётся дёргать винчестер 
и подключать его к ПЦ. Испытал на себе, это удобно. Сигнал IORQG для модема будет последним в приоритете после 4-го слота ZX-Bus.

12) Наличие мышки PS/2, контроллер на Attiny2313, с буфером, без WAITа.

13) Возможность подключения как классической механической клавиатуры, так и PS/2 без WAIT, контроллер на ATMega48PA-PU.

14) Наличие порта RS-232 с использованием музыкального сопроцессора AY и микросхемы MAX3232.

15) Турбирование контроллера дисковода КР1818ВГ93 по правильной схеме, с учётом всех исправлений описанных журнале "Спектрофон" № 12 и 14.

16) NemoIDE контроллер.

17) Доступ к 0-й странице ПЗУ с прошивкой Gluk Reset Service.

18) Наличие порта атрибутов, с использованием полной дешифрации порта 0xFF.

19) Теневое ОЗУ ёмкостью 128 Кб. Будет выполнять 2 функции - в качестве стандартного теневого ОЗУ, включающееся и выключающееся через 
чтение из портов 0xFB, 0x7B, ёмкостью 16 или 32 Кб, и для подмены всех 8х страниц ПЗУ Spectrum:

Страница 0 - стандартное теневое ОЗУ через IN A,(#FB)/IN A,(#7B), либо эмуляция 0-й страницы ПЗУ Gluk Reset Service;

Страница 1 - только эмуляция 1-й страницы ПЗУ TR-DOS;

Страница 2 - расширение стандартного теневого ОЗУ до 32Кб, либо эмуляция 2-й страницы ПЗУ Menu-128;

Страница 3 - только эмуляция 3-й страницы ПЗУ Basic-48.

Страница 4 - эмуляция 0-й страницы ПЗУ Редакто Basic-128 +3

Страница 5 - эмуляция 1-й страницы ПЗУ Обработчик ошибок Basic-128 +3

Страница 6 - эмуляция 2-й страницы ПЗУ Basic-48 +3

Страница 7 - эмуляция 3-й страницы ПЗУ +3 DOS

19) Микросхема CMOS-часиков по схеме MrGluk. Можно устанавливать как Dallas, так и МС146818 или её аналог 512ВИ1. Тактирование последних 
двух происходит от экономичной микросхемы MC14069. Внешняя батарейка - CR2032, которая будет использоваться для любого варианта CMOS, 
в том числе и для Dallas (в случае, если используется старый чип Dallas с давно разряженной внутренней батарейкой).
Порты для управления CMOS - 0xBFF7, 0xDFF7 и 0xEFF7.

20) 9 расширенных видеорежимов (в скобках кол-во циклов доступа к ОЗУ видеоконтроллером за 1 адрес):

20.0) "Стандартный видеорежим". 256х192 pix, атрибут цвета на знакоместо 8х8, разрешение для атрибутов 32х24. Область пикселей - 0x4000 - 0x57FF, область атрибутов - 0x5800 - 0x5AFF 
(2 цикла чтения из ОЗУ);

20.1) "Аппаратный мультиколор". 256х192 pix, атрибут цвета на байт 8х1, разрешение для атрибутов 32х192. Область пикселей - 0x4000 - 0x57FF, область атрибутов - 0x6000 - 0x77FF 
(2 цикла чтения из ОЗУ);

20.2) "512х192 pix, монохромный". Через порт BIOS можно выбрать любой цвет текста. Область пикселей нечётного знакоместа - 0x4000 - 0x57FF, область 
пикселей чётного знакоместа - 0x6000 - 0x77FF (4 цикла чтения из ОЗУ, для совместимости с цветным вариантом);

20.3) "512х192 pix, цветной". Атрибут на знакоместо 8х8, разрешение для атрибутов 64х24. Область пикселей нечётного знакоместа - 0x4000 - 0x57FF, область 
атрибутов нечётного знакоместа - 0x5800 - 0x5AFF, область пикселей чётного знакоместа - 0x6000 - 0x77FF, область атрибутов чётного 
знакоместа - 0x7800 - 0x7AFF (4 цикла чтения из ОЗУ);

20.4) "512х192 pix, мультиколорный". Атрибут на байт 8х1, разрешение для атрибутов 64х192. Область пикселей нечётного знакоместа - 0x4000 - 0x57FF, область пикселей 
чётного знакоместа - 0x6000 - 0x77FF, область атрибутов нечётного знакоместа - 0xC000 - 0xD7FF 4-й страницы, область атрибутов чётного 
знакоместа - 0xE000 - 0xF7FF 4-й страницы (4 цикла чтения из ОЗУ);

20.5) "16 colors" - каждый пиксель своим цветом. Экран состоит из 4-х экранных областей: 0x4000 - 0x57FF, 0x6000 - 0x77FF, 0xC000 - 0xD7FF 
4-й страницы, 0xE000 - 0xF7FF 4-й страницы. Каждый байт данных отображает 2 пикселя, каждая экранная область отображает свои 2 пикселя из знакоместа, 4 области составляют целое знакоместо (4 цикла чтения из ОЗУ);

20.6) "384х288 pix, полноэкранный режим без бордюра". Разрешение для атрибутов 48х36 (2 цикла чтения из ОЗУ);

20.7) "FlashColor". Можно применять в комбинации с видеорежимами 20.0, 20.1, 20.3, 20.4 и 20.6. Внутри каждого цветного атрибута, в котором активирован 7-й бит "флеш", вместо стандартного мигания знакоместа, перемешиваются цвета пикселей и фона и выводятся результат для пикселей, цвет фона при этом чёрный.

20.8) "Аппаратный GigaScreen", автоматический. Можно применять в комбинации с любым видеорежимом. Выводит на экран основной и дополнительный экраны с черезстрочным чередованием, с инверсией переключения через кадр. Включается при условии, если программа просмотра гигаскрин-картинок начинает переключать по прерываниям основной / дополнительный экран. Когда переключение произошло, запускается переключение экранов через строку и продолжается до прихода кадрового импульса. Если программное переключение экранов прекратилось, аппаратный гигаскрин не включается. За счёт черезстрочного переключения экранов, мерцание на гигаскрин картинках становится значительно менее заметно.

Видеорежимы "Аппаратный мультиколор", "512х192", "16 colors" и "384х288" включаются стандартным портом 0xEFF7.
Видеорежим "512х192" из монохромного в цветной или обратно переключается дополнительным портом 0xFE37, управляемый из BIOS.
Видеорежим "512х192" мультиколорный включается, если через 0xEFF7 включить одновременно режимы "Мультиколор" и "512х192", а так же 
включить цвет портом 0xFE37.

20.9) Регистр палитры (совместим с АТМ Турбо 2+): Возможность переопределять стандартные 16 цветов на любые из палитры 4096 цветов. Палитра обеспечивает 12 битный цвет: для каждой компоненты R, G, B можно задавать любое 4-битное значение. Таким образом получается по 16 уровней для красного, зелёного и синего, что в совокупности даёт 4096 цветов и оттенков.

Программируется палитра в момент, пока на экране отображается бордюр. Для этого необходимо сначала задать номер исходного цвета из 16, который необходимо переназначить, включив соответствующий Border:

биты 0, 1 и 2 - записывая в порт #FE значения от 0 до 7, бит 3 - записывая в порт #F6 значение 8.

Затем задать нужный цвет из палитры путём записи в порт # xxFF значение цвета. При этом по шине данных задаются первые 6 бит цвета, а по шине адреса - вторые 6 бит.

Раскладка 12-битного цвета при записи в порт #xxFF:

||| Палитра: ||| R0... | R1... | R2... | R3... ||| G0... | G1... | G2... | G3... ||| B0... | B1... | B2... | B3... |||

||| Порт #FF ||| A14 | A9... | D6... | D1... ||| A15 | A12 | D7... | D4... ||| A13 | A8... | D5... | D0... |||

21) SoundDrive с поддержкой режима Covox. В качестве микросхем ЦАП использованы TLC7528, что значительно упростило принципиальную схему.

22) BIOS с тестированием ОЗУ и Setup-ом. Установлена дополнительная микросхема ПЗУ ёмкостью 64 Кбайта. 

22.1) В BIOS-Setup можно:

22.1.1. Выставлять текущую дату и время;

22.1.2. Настроить расширенные видеорежимы:

а) выбрать цвет текста для монохромного видеорежима 512х192;

б) включить или отключить цвет для видеорежима 512х192;

в) включить или отключить флешколор;

г) включить или отключить автоматический аппаратный гигаскрин.

3. Настроить теневое ОЗУ - включать и отключать эмуляцию ПЗУ для каждой из 4-х страниц;

4. Настроить поведение Спектрума при сбросе:

а) Выход в Gluk Reset Service;

б) Выход в Menu-128;

в) Выход в TR-DOS;

г) Выход в TR-DOS без очистки ОЗУ;

д) Выход в Basic-48;

е) Загрузка с HDD Master;

ж) Загрузка с HDD Slave;

з) При выборе варианта загрузки с HDD, можно выбирать варианты, что именно загружать:

DNA-OS;

iS-DOS;

пользовательский вариант номера блока LBA.

22.1.3. Выбрать порты расширения верхней памяти >128 КБ;

22.1.4. Включать и отключать режим Мультизадачности.

23) Конструктивно всё это собрано на двух платах: Материнская плата имеет размер стандартного ATX, что позволит её установить 
в стандартный корпус ATX, разводка 4-слойная. Вторая плата имеет размеры 170x170 мм и будет крепиться к материнской плате вверху 
и на ней будут располагаться 5 внешних коннекторов: Сдвоенный PS/2 - мышка + клавиатура, DB15 (female) - механическая клавиатура, 
DB9 (female) - кэмпстон джойстик, DA-15 (VGA), S-Video и RCA 3 шт - видео и аудио стерео. 
Остальные коннекторы - 3 шт. мини-джек (аудио-выход, магнитофонные вход и выход), DB9 (male - порт RS-232) и DB25 (принтер) придётся 
разместить на планках.
